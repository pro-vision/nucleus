/* code-preview-toggle.js -- Handles openi
 *
 * With contributions from: -
 * fritz, @gotofritz
 *
 * This software may be modified and distributed under the terms
 * of the MIT license. See the LICENSE file for details.
 */

'use strict';

/** Directive */
$(document).ready(function(){
  /**
   * the iframe substitution means that the "code examples" would only be
   * <iframe id="ifrm_xxxx" ....
   * which is obviously useless. This waits for the iframes to be loaded
   * and then fetches the sources (it will try to get the topmost
   * <section, failing that the whole body)
   */
  var shouldCheckIframes = false;
  var thisOften = 2000;
  var loadedFlag = "loaded";

  setTimeout(copyMarkupFromIframes, thisOften * 3);

  function copyMarkupFromIframes() {
    shouldCheckIframes = false;
    $('iframe[id^="ifrm_"]:not([' + loadedFlag + '])').each(function(n, iframe) {
      var iframeDoc = iframe.contentWindow.document;
      if (iframeDoc.readyState === "loading") {
        shouldCheckIframes = true;
      }
      else {
        // don't check this iframe anymore
        iframe.setAttribute(loadedFlag, true);

        // clone node so that we can throw away all the stuff we don't need
        const $markupClone = $(iframe.contentWindow.document.body).find('section').length > 0
          ? $(iframe.contentWindow.document.body)
            .find('section')
            .first()
          : $(iframe.contentWindow.document.body).clone();


        // get the html code of the iframe content (assumes it is loaded ...)
        const html = $markupClone.get(0).outerHTML.trim();


        // the markup generated by nucleus is <iframe ... > because that's what
        // we define the include. But we don't want to show that, we want to show
        // the markup of the document in the iframe


        // Prism is the library packed with Nucleus
        const syntaxHighlightedHTML = Prism.highlight(html, Prism.languages.html);

        // here we put the markup we want to show in the 'show example' div,
        $(iframe)
          .parents('div.wb-content-grid__row')
          .next()
          .find('.SG-component__markup')
          .get(0).innerHTML = syntaxHighlightedHTML;

        // here we put the markup we want to show in the 'copy markup' button,
        $(iframe)
          .parents('div.wb-content-grid__row')
          .prev().prev()
          .find('[data-d-copy]')
          .attr('data-clipboard-text', html);

        // remove vertical scrollbars in the  iframe
        $(iframe.contentWindow.document.body).css({ overflowY: 'hidden'});
      }
    });

    // keep running until all iframes are loaded
    if (shouldCheckIframes) {
      setTimeout(copyMarkupFromIframes, thisOften);
    }
  }
});
